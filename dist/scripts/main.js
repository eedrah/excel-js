"use strict";function TableBuilder(e){this.$table=e}function DataBinder(){this.cells=[]}function Cell(e,t,n){this.row=e,this.column=t,this.notificationCallback=n,this.fnToOtherCells=dataBinder.getCellAt.bind(dataBinder),this.precedents=[],this.descendants=[],this._formula="",this._value=""}function FormulaParser(e){this.fnToOtherCells=e,this.isValid=!1,this.isDetermined=!1,this.value=null,this.precedents=[]}function Formatter(){}var ReferenceHelper=function(){function e(t){if(0===t)return"";var n=t-1,l=i[n%i.length],a=Math.floor(n/26),s=e(a);return s+l}function t(e){var n=i.indexOf(e.slice(-1))+1;return e.length>1&&(n+=26*t(e.slice(0,-1))),n}function n(e){var n=/(\d+)/,i=e.split(n);return{row:i[1],column:t(i[0])}}var i="ABCDEFGHIJKLMNOPQRSTUVWXYZ";return{NumericToAlpha:e,A1ToRC:n,AlphaToNumeric:t}}();TableBuilder.prototype={build:function(){this.addHeaderRow(),this.addDataRows()},addHeaderRow:function(){var e=$("<tr>");e.append($("<th>"));for(var t=1;100>=t;t++)this.addColumnHeaderCell(e,t);this.$table.append(e)},addColumnHeaderCell:function(e,t){var n=ReferenceHelper.NumericToAlpha(t),i=$("<th>");i.text(n),e.append(i)},addDataRows:function(){for(var e=1;100>=e;e++)this.addDataRow(e)},addDataRow:function(e){var t=$("<tr>"),n=$("<th>").text(e);t.append(n);for(var i=1;100>=i;i++){var l=$("<td>").append($('<input type="text">'));t.append(l)}this.$table.append(t)}},DataBinder.prototype={initialize:function(e){var t=100,n=100;this.$table=e,this.inputs=e.find("input"),this._initializeCellsArray(t,n),this._bindInputsToArray(),this._bindRefreshButton()},_initializeCellsArray:function(e,t){for(var n=0;e>n;n++){for(var i=[],l=0;t>l;l++){var a=this.createNotificationCallback(n,l);i.push(new Cell(n,l,a))}this.cells.push(i)}},_bindInputsToArray:function(){this.inputs.change(this,function(e){var t=e.data,n=$(this),i=n.closest("tr").index(),l=n.closest("td").index();t.cells[i-1][l-1].notifyInputChange(n.val())})},_bindRefreshButton:function(){$("#refreshTable").click(this.refreshAllCells.bind(this))},refreshAllCells:function(){this.inputs.val(""),this.cells.forEach(function(e){e.forEach(function(e){e.broadcastValue()})})},createNotificationCallback:function(e,t){return function(n){this._notifyCellChange(e,t,n)}.bind(this)},_notifyCellChange:function(e,t,n){this.inputs.eq(100*e+t).val(n)},getCellAt:function(e,t){return this.cells[e-1][t-1]}},Cell.prototype={notifyInputChange:function(e){"="===e[0]?this.setFormula(e.slice(1)):this.setValue(e)},setValue:function(e){e!==this._value&&(this._value=e,this._formula=e,this.releaseCurrentPrecedents(),this.broadcastValue())},broadcastValue:function(){this.notificationCallback(this._value),this.notifyDescendants()},setFormula:function(e){var t=new FormulaParser(this.fnToOtherCells);t.parse(e),t.isValid?(this.setValue(t.value),this.updatePrecedents(t.precedents),this._formula=e,this.notifyDescendants()):this.setValue("#Error")},getValue:function(){return this._value},recalculateFormula:function(){this.setFormula(this._formula)},updatePrecedents:function(e){this.releaseCurrentPrecedents(),this.precedents=e,this.precedents.forEach(function(e){e.addDescendant(this)}.bind(this))},releaseCurrentPrecedents:function(){this.precedents.forEach(function(e){e.removeDescendant(this)}.bind(this)),this.precedents=[]},addDescendant:function(e){this.descendants.push(e)},removeDescendant:function(e){this.descendants.splice(this.descendants.indexOf(e),1)},notifyDescendants:function(){this.descendants.forEach(function(e){e.recalculateFormula()})}},FormulaParser.prototype={parse:function(e){e=this._replaceCellReferences(e),this.isDetermined!==!0&&this._compute(e)},_compute:function(e){try{var t=math.eval(e);this.isValid=!0,this.value=t}catch(n){}},_replaceCellReferences:function(e){for(var t=/\b([A-Z]+[0-9]+)\b/gi,n=e.split(t),i=1;i<n.length;i+=2)n[i]=this._replaceCellReference(n[i]);return n.join("")},_replaceCellReference:function(e){e=e.toUpperCase();var t=ReferenceHelper.A1ToRC(e),n=this.fnToOtherCells(t.row,t.column);return this.precedents.push(n),n.getValue()}},Formatter.prototype={bindButtons:function(){$("#boldBtn").click(this.makeLastCellBold),$("#italicBtn").click(this.makeLastCellItalic),$("#underlineBtn").click(this.makeLastCellUnderline)},trackSelectedCell:function(){$("input").click(this._selectCell)},_selectCell:function(e){$("input").removeClass("selected-cell"),$(e.currentTarget).addClass("selected-cell")},makeLastCellBold:function(){$(".selected-cell").toggleClass("bold")},makeLastCellItalic:function(){$(".selected-cell").toggleClass("italic")},makeLastCellUnderline:function(){$(".selected-cell").toggleClass("underline")}};var dataBinder=new DataBinder;$(function(){var e=$("table");new TableBuilder(e).build(),dataBinder.initialize(e);var t=new Formatter;t.bindButtons(),t.trackSelectedCell()});